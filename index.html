<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Formula Driver - Menu</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
        <link href='https://fonts.googleapis.com/css?family=Noto Serif' rel='stylesheet'>
        <link rel="stylesheet" type="text/css" href="style.css"/>
    </head>
    
    <body>
        <script src="js/three.js"></script>
        <script src="js/OBJLoader.js"></script>
        
        <script>
            // Global variables
            var scene;
            var camera;
            var renderer;
            var ambientLight;
            var pointLight;
            var pointLight2;
            var loader;
            var objects = new THREE.Group(); // The 3D models will be permanently saved here, without altering them, as a backup for when the game restarts
            var models = new THREE.Group(); // It uses the same models as "objects", but we will change them during the course of the game
            var loaded = false; // Indicates if the models have already been loaded
            
            var title; // Container with the title screens and the "Play", "Options" and "About" buttons
            var playButton;
            var optionsButton;
            var aboutButton;
            var options; // Container with the options
            var easyButton;
            var normalButton;
            var hardButton;
            var resolutionNativeButton;
            var resolutionLowButton;
            var shadowsOnButton;
            var shadowsOffButton;
            var fogOnButton;
            var fogOffButton;
            var ferrariButton;
            var mercedesButton;
            var redbullButton;
            var optionsExitButton; // Button that closes the Option container
            var about; // Container with the synopsis and commands
            var aboutExitButton; // Button that closes the About container
            var hud; // It shows the current score of the player
            var gameOverScreen; // Screen that shows up when you crash
            
            var menuAnimation; // Timer for the menu animation
            var gameplayAnimation; // Timer for the gameplay animation
            var leftOrRight = 0; // The player turns their car to 0: neutral, 1: left, 2: right
            var cockpit = true; // Type of camera view - true: cockpit view, false: third-person camera
            var pause = false; // Indicates if the game is paused
            var menu = true; // Indicates if the player is currently in the menu screen
            
            var maxSteering = 0.5; // How far the steering wheel can turn
            var steering = 0.1; // How much the steering wheel turns at each frame
            var carTurning = 0.02; // How much the car rotates when turning the wheel at each frame
            var headTurning = 0.05; // How much the pilot's head rotates when turning the wheel at each frame
            var tyreTurning = 0.03; // How much the car's tyres rotate when turning the wheel at each frame
            var tyreSpeed = 0.05; // How fast the tyres move
            var speed = 0.005; // The velocity of the car (aka how much the objects on the road move)
            var spawnPoint = 0.5; // Coordinate X where the new objects on the road should spawn
            
            var collisionBoxPlayer;
            var collisionBoxPlayerVisible;
            var collisionOpponent;
            var collisionOpponentVisible;
            
            var choosenDifficulty = 1.0; // 0.5: Easy, 1: Normal, 1.5: Hard. Choosen through the main menu
            var difficulty = 1.0; // Actual difficulty during game. It increases every 50 passes.
            var team = 0; //0: Ferrari, 1: Mercedes, 2: RedBull
            var carSpawner; // Timer for the spawn of the opponent cars
            var timer = 0; // Timer used in carSpawner
            var passes = 0; // How many opponent cars the player has passed
            var crash = false; // Indicates if the player has crashed
            var crashType = 0; // 0: The car spins to the left, 1: The car spins to the right
            var damagedTyreDirection = false; // The damaged tyre switches between two directions
            
            var textureLogoTeam; // Contains the texture that represent the logo of the team choosen
            var lowResolution = false; // Indicates if the player has choosen a low resolution
            var shadows = false; // Indicates if shadows are enabled
            var fogEnabled = false; // Indicates if fog has been enabled
            var source = 'models.json'; // Where to find the models
            
            // Sets up the basics of the scene. Auxiliary function of createMenu()
            function setScene() {
                scene = new THREE.Scene(); // We create the scene
                scene.background = new THREE.Color(0xffffff); // The background is white
            
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); // We create a perspective camera. (Parameters: fov, aspect ratio, near plane, far plane)
                camera.position.set(-8,5,4); // We move the camera from the origin position
                camera.up = new THREE.Vector3(0,1,0); // The orientation of the camera
                camera.lookAt(new THREE.Vector3(0,0,0)); // We tell the camera to tell at the origin of the scene
              
                renderer = new THREE.WebGLRenderer({antialias: true}); // We create a WebGLRenderer with antialiasing enabled
                setResolutionRenderer(); // We apply the resolution choosen to the renderer
                renderer.shadowMap.enabled = true; // The renderer is able to render shadows
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Filters shadows through an algorithm that saves up some resources
                document.body.appendChild(renderer.domElement); // We add the renderer (which is a canvas) to the body of the HTML file
            
                ambientLight = new THREE.AmbientLight(0xffffff, 1.0); // We create a white ambientLight that lights up the whole scene
                scene.add(ambientLight);
            
                pointLight = new THREE.PointLight(0xffffff, 1.0); // We create a white pointLight
                pointLight.position.set(9.0, 8.0, 0.0);
                scene.add(pointLight);
            
                pointLight2 = new THREE.PointLight(0xffffff, 1.0); // We create a second white pointLight for presentation purposes
                pointLight2.position.set(-2.0, 5.0, 4.0);
                scene.add(pointLight2);
                
                window.addEventListener('resize', function(event) { // The browser window has changed size!
                    setResolutionRenderer(); // We apply a new resolution to the renderer
                    camera.aspect = window.innerWidth / window.innerHeight; // Scale the aspect ratio of the camera and update its projection matrix
                    camera.updateProjectionMatrix(); } ); }
            
            // Loads the models in the .json file and add them to the scene. Auxiliary function of createMenu()
            function modelsLoader() {
                loader = new THREE.ObjectLoader(); // Loader we use the load the models
                loader.load(source, 
                        function (object) {
                            objects = object; // The models can now be used outside the loader
                            objects.traverse(function (child) { // We print on the console the names of the object's children
                                console.log(child.name); } );
                            loaded = true;
                            tweakModels(); },
                             
                
                        function (xhr) { // We print the current state of the loading process
                            console.log((xhr.loaded / xhr.total * 100) + '% loaded'); },
                
                        function (error) { // We print this if an error has occurred during the loading
                            console.log('An error happened'); } ); }
            
            // Alters some aspects of the models once they are loaded in. Auxiliary function of createMenu()
            function tweakModels() {
                models = objects.clone(true);
                models.rotateY(-0.3); // We slightly rotate the models for better presentation when the game first loads
                // Hide elements
                models.getObjectByName("Torso Cockpit").visible = false; // We hide the children that must NOT show up in the menu
                models.getObjectByName("Left Hand").visible = false;
                models.getObjectByName("Right Hand").visible = false;
                models.getObjectByName("Gameplay Road").visible = false;
                models.getObjectByName("Damaged Front").visible = false;
                models.getObjectByName("Front").visible = true;
                    
                // Create collisions box
                collisionBoxPlayerVisible = new THREE.BoxHelper().setFromObject(models.getObjectByName("Front")); // We create an helperBox, which will help us visualize the collision box in the game itself for DEBUGGING purposes
                collisionBoxPlayerVisible.scale.set(1.0, 0.8, 0.1); // We resize the boxHelper to better fit the front the car
                collisionBoxPlayerVisible.updateMatrix(); // We update the matrix, so the changes take place
                collisionBoxPlayerVisible.visible = false; // We hide the helperBox
                models.getObjectByName("Front").add(collisionBoxPlayerVisible); // Add the helperBox to the scene
                collisionBoxOpponentVisible = new THREE.BoxHelper().setFromObject(models.getObjectByName("Opponent Back")); // We now do the same for the opponent car's back
                collisionBoxOpponentVisible.scale.set(0.7, 0.8, 0.2);
                collisionBoxOpponentVisible.updateMatrix();
                collisionBoxOpponentVisible.name = "Collision Box Visible"; // We add a name, so the box can be referenced later by the getObjectByName() function
                collisionBoxOpponentVisible.visible = false;
                models.getObjectByName("Opponent Back").add(collisionBoxOpponentVisible);
                    
                // Adjust materials
                models.getObjectByName("Pit Road").material.roughness = 1.00;
                models.getObjectByName("Gameplay Road").material.roughness = 1.00;
                    
                // Add textures and set right colors
                var texturePirelli = new THREE.TextureLoader().load("textures/Pirelli.png"); // Texture for the upper part of the underpass
                texturePirelli.wrapS = THREE.RepeatWrapping; // The texture repeats itself across the U,V coordinates
                texturePirelli.wrapT = THREE.RepeatWrapping;
                texturePirelli.anisotropy = renderer.capabilities.getMaxAnisotropy(); // This ensures a texture that is NOT blurry
                texturePirelli.rotation = 1.57;
                models.getObjectByName("Upper Underpass").material.map = texturePirelli; // We map the texture to the material
                var textureTyres = new THREE.TextureLoader().load("textures/TyreNormal.jpg"); // Normal texture for the tyres
                textureTyres.wrapS = THREE.RepeatWrapping;
                textureTyres.wrapT = THREE.RepeatWrapping;
                models.getObjectByName("Left Anterior Tyre").material.normalMap = textureTyres;
                models.getObjectByName("Right Anterior Tyre").material.normalMap = textureTyres;
                models.getObjectByName("Left Posterior Tyre").material.normalMap = textureTyres;
                models.getObjectByName("Right Posterior Tyre").material.normalMap = textureTyres;
                var textureMetal = new THREE.TextureLoader().load("textures/MetalNormal.jpg"); // Normal texture for the body of the car
                textureMetal.wrapS = THREE.RepeatWrapping;
                textureMetal.wrapT = THREE.RepeatWrapping;
                models.getObjectByName("Front").material.normalMap = textureMetal;
                models.getObjectByName("Front").material.normalScale = new THREE.Vector2(0.1, 0.1);
                setTeamColors(); // We apply the right colors and logo texture to the car
                    
                // Create texture for the screen on the wheel
                wheelScreenText();
                    
                scene.add(models); // We add the models to the scene
                if (shadows == true) { // We enable shadows if the option is selected
                        setShadows(); } }
            
            // Creates the menu screens. Auxiliary function of createMenu()
            function createMenuText() {
                title = document.createElement('div'); // We create the title logo of the game
                title.id = "title"; // How the logo should be rendered is detailed in the style.css file
                title.innerHTML = "Formula Driver"; // The text inside the div
                document.body.appendChild(title); // We add the div to the body of the HTML file
                
                playButton = document.createElement('button'); // Creates the Play button inside the title element
                playButton.id = "Play";
                playButton.innerHTML = "PLAY";
                playButton.style.background = "yellow"; // The button is yellow as well
                title.appendChild(playButton);
                
                optionsButton = document.createElement('button'); // Creates the Options button inside the title element
                optionsButton.id = "Options";
                optionsButton.innerHTML = "OPTIONS";
                optionsButton.style.background = "yellow";
                title.appendChild(optionsButton);

                aboutButton = document.createElement('button'); // Creates the About button inside the title element
                aboutButton.id = "About";
                aboutButton.innerHTML = "!";
                aboutButton.style.background = "yellow";
                title.appendChild(aboutButton);
                
                easyButton = document.createElement('button'); // We create all the buttons inside the Options screen
                easyButton.id = "Easy";
                easyButton.innerHTML = "EASY";
                if (choosenDifficulty == 0.5) { // We disable buttons if their options have already been choosen
                    easyButton.disabled = true; }
                normalButton = document.createElement('button');
                normalButton.id = "Normal";
                normalButton.innerHTML = "NORMAL";
                if (choosenDifficulty == 1.0) {
                    normalButton.disabled = true; }
                hardButton = document.createElement('button');
                hardButton.id = "Hard";
                hardButton.innerHTML = "HARD";
                if (choosenDifficulty == 1.5) {
                    hardButton.disabled = true; }
                
                resolutionLowButton = document.createElement('button');
                resolutionLowButton.id = "Low";
                resolutionLowButton.innerHTML = "LOW";
                if (lowResolution == true) {
                    resolutionLowButton.disabled = true; }
                resolutionNativeButton = document.createElement('button');
                resolutionNativeButton.id = "Native";
                resolutionNativeButton.innerHTML = "NATIVE";
                if (lowResolution == false) {
                    resolutionNativeButton.disabled = true; }
                
                shadowsOffButton = document.createElement('button');
                shadowsOffButton.id = "shadowsOff";
                shadowsOffButton.innerHTML = "OFF";
                if (shadows == false) {
                    shadowsOffButton.disabled = true; }
                shadowsOnButton = document.createElement('button');
                shadowsOnButton.id = "shadowsOn";
                shadowsOnButton.innerHTML = "ON";
                if (shadows == true) {
                    shadowsOnButton.disabled = true; }
                    
                fogOffButton = document.createElement('button');
                fogOffButton.id = "fogOff";
                fogOffButton.innerHTML = "OFF";
                if (fogEnabled == false) {
                    fogOffButton.disabled = true; }
                fogOnButton = document.createElement('button');
                fogOnButton.id = "fogOn";
                fogOnButton.innerHTML = "ON";
                if (fogEnabled == true) {
                    fogOnButton.disabled = true; }
                 
                ferrariButton = document.createElement('button');
                ferrariButton.id = "Ferrari";
                ferrariButton.innerHTML = "FERRARI";
                if (team == 0) {
                    ferrariButton.disabled = true; }
                mercedesButton = document.createElement('button');
                mercedesButton.id = "Mercedes";
                mercedesButton.innerHTML = "MERCEDES";
                if (team == 1) {
                    mercedesButton.disabled = true; }
                redbullButton = document.createElement('button');
                redbullButton.id = "Redbull";
                redbullButton.innerHTML = "REDBULL";
                if (team == 2) {
                    redbullButton.disabled = true; }
                
                options = document.createElement('div'); // Creates a div where all the options are displayed
                options.id = "description";
                options.style.textAlign = "center";
                options.innerHTML = "Difficulty: <br>";
                options.appendChild(easyButton); 
                options.appendChild(normalButton);
                options.appendChild(hardButton);
                options.innerHTML += "<br>(Difficulty affects initial speed of the car)";
                options.innerHTML += "<br><br>Resolution: <br>";
                options.appendChild(resolutionLowButton);
                options.appendChild(resolutionNativeButton);
                options.innerHTML += "<br>(If the game runs poorly, choose 'LOW')";
                options.innerHTML += "<br><br>Shadows: <br>";
                options.appendChild(shadowsOffButton);
                options.appendChild(shadowsOnButton);
                options.innerHTML += "<br>('ON' option may impact performance)";
                options.innerHTML += "<br><br>Fog: <br>";
                options.appendChild(fogOffButton);
                options.appendChild(fogOnButton);
                options.innerHTML += "<br>('ON' option may impact performance)";
                options.innerHTML += "<br><br>Team: <br>";
                options.appendChild(ferrariButton);
                options.appendChild(mercedesButton);
                options.appendChild(redbullButton);
                options.innerHTML += "<br>(Team selection is purely cosmetic)<br><br>";
                document.body.appendChild(options);
                options.style.visibility = "hidden";
                
                optionsExitButton = document.createElement('button'); // Button that lets you close the Options screen
                optionsExitButton.id = "optionsExit";
                optionsExitButton.innerHTML = "CLOSE";
                options.appendChild(optionsExitButton);
                
                about = document.createElement('div'); // Creates a div where the synopsis and controlls are displayed
                about.id = "description";
                var synopsis = document.createElement('div');
                synopsis.innerHTML = "PREMISE";
                synopsis.style.textAlign = "center";
                about.appendChild(synopsis);
                about.innerHTML += "It was supposed to be an easy weekend, but after an unfortunate qualifying session, you had to start the race at the last place.<br>";
                about.innerHTML += "Not all hope is lost however!<br>";
                about.innerHTML += "Your car is still the fastest of the grid and the layout of the track, an unnatural long straight, gives you ample possibilities to pass your rivals... who happen to be in thousands!<br>";
                about.innerHTML += "To help you, your engineers have installed a device that increases your speed after every 50 passes: just be careful!<br>";
                about.innerHTML += "See you on the track, driver!<br><br>";
                var controls = document.createElement('div');
                controls.innerHTML = "CONTROLS";
                controls.style.textAlign = "center";
                about.appendChild(controls);
                about.innerHTML += "- 'a': Move your car to the left.<br>";
                about.innerHTML += "- 'd': Move your car to the right.<br>";
                about.innerHTML += "- 'v': Switch between the two camera views.<br>";
                about.innerHTML += "- 'p': Pause or resume the game.<br><br>";
                document.body.appendChild(about);
                about.style.visibility = "hidden";
                
                aboutExitButton = document.createElement('button'); // Button that lets you close the About screen
                aboutExitButton.id = "aboutExit";
                aboutExitButton.innerHTML = "CLOSE";
                var center = document.createElement('div'); // Divider needed to center the button
                center.style.textAlign = "center";
                about.appendChild(center);
                center.appendChild(aboutExitButton); }
            
            // Assign the events to each button in the menu. Auxiliary function of createMenu()
            function assignButtons() {
                // Open Options scren
                optionsButton.onclick = function() {
                    this.disabled = true;
                    aboutButton.disabled = false;
                    options.style.visibility = "visible";
                    about.style.visibility = "hidden"; }
                
                // Option events: difficulty
                document.getElementById("Easy").onclick = function() { // For some reason easyButton.onclick doesn't work: the same for the following buttons
                    this.disabled = true;
                    document.getElementById("Normal").disabled = false;
                    document.getElementById("Hard").disabled = false;
                    choosenDifficulty = 0.5; }
                    
                document.getElementById("Normal").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Easy").disabled = false;
                    document.getElementById("Hard").disabled = false;
                    choosenDifficulty = 1.0; }
                    
                document.getElementById("Hard").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Easy").disabled = false;
                    document.getElementById("Normal").disabled = false;
                    choosenDifficulty = 1.5; }
                 
                // Option events: resolution
                document.getElementById("Low").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Native").disabled = false; 
                    lowResolution = true;
                    setResolutionRenderer(); }
                
                document.getElementById("Native").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Low").disabled = false;
                    lowResolution = false;
                    setResolutionRenderer(); }
                
                // Option events: shadows
                document.getElementById("shadowsOff").onclick = function() {
                    this.disabled = true;
                    document.getElementById("shadowsOn").disabled = false;
                    shadows = false;
                    setShadows(); }
                    
                document.getElementById("shadowsOn").onclick = function() {
                    this.disabled = true;
                    document.getElementById("shadowsOff").disabled = false; 
                    shadows = true;
                    setShadows(); }
                    
                // Option events: fog
                document.getElementById("fogOff").onclick = function() {
                    this.disabled = true;
                    document.getElementById("fogOn").disabled = false;
                    fogEnabled = false; }
                    
                document.getElementById("fogOn").onclick = function() {
                    this.disabled = true;
                    document.getElementById("fogOff").disabled = false; 
                    fogEnabled = true; }
                
                // Option events: teams
                document.getElementById("Ferrari").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Mercedes").disabled = false;
                    document.getElementById("Redbull").disabled = false;
                    team = 0;
                    setTeamColors(); }
                    
                document.getElementById("Mercedes").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Ferrari").disabled = false;
                    document.getElementById("Redbull").disabled = false;
                    team = 1;
                    setTeamColors(); }
                
                document.getElementById("Redbull").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Ferrari").disabled = false;
                    document.getElementById("Mercedes").disabled = false; 
                    team = 2;
                    setTeamColors(); }
                 
                // Closes Option screen
                optionsExitButton.onclick = function() {
                    optionsButton.disabled = false;
                    options.style.visibility = "hidden"; }
                
                // Open the About screen
                aboutButton.onclick = function() { 
                    this.disabled = true;
                    optionsButton.disabled = false;
                    about.style.visibility = "visible";
                    options.style.visibility = "hidden"; }
                
                // Closes the About screen
                aboutExitButton.onclick = function() {
                    aboutButton.disabled = false;
                    about.style.visibility = "hidden"; }
                
                // Begings the game
                playButton.onclick = function() {
                    createGameplay(); }; }
                    
            // Creates the menu of the game. Auxiliary function of init()
            function createMenu() {
                document.title = "Formula Driver - Menu"; 
                setScene();
                if (loaded == false) { // Loads the models and then tweak them (tweakModels() is contained inside modelsLoader())
                    modelsLoader(); } 
                else { // Just tweaks the models since they are already loaded in
                    tweakModels(); }
                createMenuText();
                assignButtons(); }
             
            // Animates the menu. Auxiliary function of init()
            function animateMenu() {
                scene.rotateY(0.002); // The entire scene rotate slowly on the Y axis
                menuAnimation = requestAnimationFrame(animateMenu); // The canvas is updated at each frame
                renderer.render(scene, camera); } // We use the renderer to render the scene and the camera
            
            // Spawn a new opponent car at the end of the road. Auxiliary function of createGameplay() and animateGameplayRoad()
            function spawnNewCar() {
                if (pause == false) { // We update the timer if the game has not been paused
                    timer = timer+1;
                    if (timer >= 30*(2-difficulty)) { // The max value for the timer depends on the actual difficulty level
                        timer = 0; // Wer reset the timer. Time to spawn a new car!
                        var min = -0.385; // Left side of the road
                        var max = 0.385; // Right side of the road
                        var positionY = (Math.random() * (max - min) + min).toFixed(3); // Chooses a value between min and max
                        var car = new THREE.Group(); // Creates a new opponent car
                        car = models.getObjectByName("Opponent Body").clone(true);
                        models.getObjectByName("Gameplay Road").add(car); // Add the car to the road in the random coordinates obtained
                        car.position.set(-spawnPoint, positionY, car.position.z);
                        var color = Math.floor(Math.random() * 5); // Chooses a random color for the opponent car
                        var material = new THREE.MeshStandardMaterial(); // Create a new material where we apply the color
                        if (color == 0) { // Yellow
                            material.color = new THREE.Color(0xffff00); }
                        else if (color == 1) { // Light Blue
                            material.color = new THREE.Color(0x0000ff); }
                        else if (color == 2) { // Purple
                            material.color = new THREE.Color(0x800080); }
                        else if (color == 3) { // Orange
                            material.color = new THREE.Color(0xff8000); }
                        else if (color == 4) { // Green
                            material.color = new THREE.Color(0x008000); }
                        car.material = material; // Apply the material to the car
                        car.getObjectByName("Opponent Back").material = material; 
                        car.getObjectByName("Opponent Front").material = material;
                        car.getObjectByName("Opponent Right Side").material = material;
                        car.getObjectByName("Opponent Left Side").material = material; } }
                if (crash == false) { // No new cars are spawned if there's a crash
                    requestAnimationFrame(spawnNewCar); } }
            
            // Adds controls to the game. Auxiliary function of createGameplay()
            function setControls() {
                document.onkeydown = function() { 
                    if (event.keyCode == 65) { // The player presses 'a': the car needs to turn left
                        leftOrRight = 1; }
                    else if (event.keyCode == 68) { // The player presses 'd': the car needs to turn right
                        leftOrRight = 2; } 
                    else if (event.keyCode == 86 && pause == false && crash == false && menu == false) { // The player presses 'v': switches between the two cameras
                        if (cockpit == true) {
                            camera.position.set(-5.6, 5.1, 2.7);
                            document.getElementById("hud").style.visibility = "visible";
                            cockpit = false; }
                        else {
                            camera.position.set(0.6, 2.1, -0.3);
                            document.getElementById("hud").style.visibility = "hidden";
                            cockpit = true; } }
                    else if (event.keyCode == 80 && pause == false && crash == false && menu == false) { // The player presses 'p' while playing: the game is paused
                        pause = true;
                        document.title = "Formula Driver - Paused";
                        cancelAnimationFrame(gameplayAnimation); }
                    else if (event.keyCode == 80 && pause == true) { // The player presses 'p' when the pause is on: the game is resumed
                        pause = false;
                        document.title = "Formula Driver - In Game";
                        gameplayAnimation = requestAnimationFrame(animateGameplay); } };
                            
                document.onkeyup = function() { 
                    if (event.keyCode == 65 || event.keyCode == 68) { // The player stops turning
                        leftOrRight = 0; } };

                // EXTRA: MOBILE CONTROLS FOR MOVEMENT SO I CAN TEST THE GAME ON MY PHONE
                document.ontouchstart = function() {
                    if (event.changedTouches[0].pageX < window.innerWidth/2) {
                        leftOrRight = 1; }
                    else if (event.changedTouches[0].pageX > window.innerWidth/2) {
                        leftOrRight = 2; } };
                
                document.ontouchend = function() {
                    leftOrRight = 0; }; }
            
            // Creates the gameplay scene coming from the menu
            function createGameplay() {
                document.title = "Formula Driver - In Game"; // Change the title of the web page
                menu = false;
                
                cancelAnimationFrame(menuAnimation); // Stops the spinning animation of the menu
                
                models.getObjectByName("Human").visible = false; // Renders invisible the parts that are not needed in gameplay
                models.getObjectByName("Pit Road").visible = false;
                models.getObjectByName("Gameplay Road").visible = true; // Renders visible the parts that are needed in gameplay
                models.getObjectByName("Torso Cockpit").visible = true;
                models.getObjectByName("Left Hand").visible = true;
                models.getObjectByName("Right Hand").visible = true;
                
                document.body.removeChild(title); // Remove all text on the menu screen
                document.body.removeChild(options);
                document.body.removeChild(about);
                
                scene.rotation.set(0, 0, 0); // Rotates the scene and the models to better fit the gameplay
                models.rotation.set(0, 3.6, 0);
                scene.background = new THREE.Color(0xADD8E6); // Light blue background
                camera.position.set(0.6, 2.1, -0.3); // We set the cockpit cam
                camera.fov = 70; // We change the FOV
                camera.updateProjectionMatrix(); // We update the camera projection matrix so that we can apply the above changes
                if (fogEnabled == true) { // We apply fog to the scene if the option has been enabled
                    var fog = new THREE.Fog(new THREE.Color(0xA9A9A9), 0, 300.0);
                    scene.fog = fog; }
               
                difficulty = choosenDifficulty; // We apply the difficulty choosen 
                carSpawner = requestAnimationFrame(spawnNewCar); // We spawn a new initial opponent car every few moments.
                
                hud = document.createElement('div'); // We create the HUD
                hud.id = "hud";
                hud.innerHTML = "Passes: " + passes;
                hud.innerHTML += "<br>Speed: " + difficulty.toFixed(1);
                hud.style.visibility = "hidden";
                document.body.appendChild(hud);
                wheelScreenText();

                setControls();       
                animateGameplay(); }
            
            // Animates the player's car. Auxiliary function of animateGameplay()
            function animateGameplayPlayer() {
                var rotazione = models.getObjectByName("Left Anterior Tyre").rotation; // Gets the current rotation values of the anterior tyres
                if (leftOrRight == 1 && models.getObjectByName("Gameplay Road").position.z > -7.0) { // The player wants to turn left and there's still place on the road
                    models.getObjectByName("Gameplay Road").translateY(0.2); // Moves the road to right. The player is ALWAYS still.
                    // pointLight.translateY(0.1); // Slightly moves the light as well
                    if (models.getObjectByName("Wheel").rotation.z <= maxSteering) { // Moves the wheel if it hasn't already reached the max steering
                        models.getObjectByName("Wheel").rotateZ(steering); // Turns the wheel to left
                        models.getObjectByName("Body").rotateY(carTurning); // Turns the body of the car to left
                        models.getObjectByName("Head Cockpit").rotateY(headTurning); // Turns the pilot's head to left
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0);  // We apply the x value of the current rotation value (else the animation fails) to the anterior left tyre
                        models.getObjectByName("Left Anterior Tyre").rotateX(-tyreTurning); // Turns the left anterior tyre to the left
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); // The same for the right anterior tyre
                        models.getObjectByName("Right Anterior Tyre").rotateX(-tyreTurning); } }
                else if (leftOrRight == 2 && models.getObjectByName("Gameplay Road").position.z < 7.0) { // The player wants to turn right and there's still place on the road
                        models.getObjectByName("Gameplay Road").translateY(-0.2);
                        // pointLight.translateY(-0.1);
                        if (models.getObjectByName("Wheel").rotation.z >= -maxSteering) {
                            models.getObjectByName("Wheel").rotateZ(-steering);
                            models.getObjectByName("Body").rotateY(-carTurning);
                            models.getObjectByName("Head Cockpit").rotateY(-headTurning);
                            models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                            models.getObjectByName("Left Anterior Tyre").rotateX(tyreTurning);   
                            models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                            models.getObjectByName("Right Anterior Tyre").rotateX(tyreTurning); } }
                else if (leftOrRight == 0) { // The player stopped moving. The car returns to neutral position
                    if (models.getObjectByName("Wheel").rotation.z > 0.1) { // The player was moving to the left
                        models.getObjectByName("Wheel").rotateZ(-steering);
                        models.getObjectByName("Body").rotateY(-carTurning);
                        models.getObjectByName("Head Cockpit").rotateY(-headTurning);
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Left Anterior Tyre").rotateX(tyreTurning);
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Right Anterior Tyre").rotateX(tyreTurning); }
                    else if (models.getObjectByName("Wheel").rotation.z < -0.1) { // The player was moving to the right
                        models.getObjectByName("Wheel").rotateZ(steering);
                        models.getObjectByName("Body").rotateY(carTurning);
                        models.getObjectByName("Head Cockpit").rotateY(headTurning);
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Left Anterior Tyre").rotateX(-tyreTurning);
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Right Anterior Tyre").rotateX(-tyreTurning); } }
                
                models.getObjectByName("Left Posterior Tyre").rotateZ(tyreSpeed); // Rotates the tyres on the z axis
                models.getObjectByName("Right Posterior Tyre").rotateZ(-tyreSpeed);
                models.getObjectByName("Left Anterior Tyre").rotateZ(tyreSpeed);
                models.getObjectByName("Right Anterior Tyre").rotateZ(-tyreSpeed); }
            
            // Animates the obstacles on the road. Auxiliary function of animateGameplay()
            function animateGameplayRoad() {
                try {
                    models.getObjectByName("Gameplay Road").traverse(function (child) { // Children on the road navigate from negative x to positive x   
                        // Collision check
                        if (child.name == "Opponent Body" && child.position.x > -0.02) { // We enable collision boxes only when an opponent car is close to the player
                            collisionBoxOpponent = new THREE.Box3().setFromObject(child.getObjectByName("Collision Box Visible")); // Creation of collision boxes from boxHelpers
                            collisionBoxPlayer = new THREE.Box3().setFromObject(collisionBoxPlayerVisible);
                            if (collisionBoxOpponent.intersectsBox(collisionBoxPlayer)) { // Check intersection for collisions
                                if (models.getObjectByName("Wheel").rotation.z > 0) { // The car spins to the left
                                    crashType = 0; }
                                else if (models.getObjectByName("Wheel").rotation.z < 0) { // The car spins to the right
                                    crashType = 1; }
                                else { // The car spins in a random direction
                                    crashType = Math.floor(Math.random() * 2); }
                                crash = true; } }
                    
                        // Pass check
                        if (child.position.x > 0.01 && child.name == "Opponent Body") { // Check if the opponent is behind you
                            models.getObjectByName("Gameplay Road").remove(child); // Deletes the child from the road: saves resources! (IT ALSO CAUSES AN EXCEPTION FOR WHATEVER REASON)
                            passes += 1;
                            if (passes % 50 == 0) { // Check if there are enough passes to increase the speed
                                difficulty += 0.1; }      
                            wheelScreenText(); // Refresh the screen on the wheel
                            document.getElementById("hud").innerHTML = "Passes: " + passes; // Refresh the hud
                            document.getElementById("hud").innerHTML += "<br>Speed: " + difficulty.toFixed(1); }
                    
                        // Underpass spawn check
                        if (child.position.x > spawnPoint/2 && (child.name == "Right Underpass" || child.name == "Left Underpass" || child.name == "Upper Underpass")) {
                            child.position.set(-spawnPoint, child.position.y, child.position.z); } // Spawn a new underpass
                    
                        // Movement of the objects on the road
                        if (child.name == "Upper Underpass") {
                            child.translateX(speed*difficulty); }
                        else if (child.name == "Left Underpass" || child.name == "Right Underpass") {            
                            child.translateX(-speed*difficulty); }
                        else if (child.name == "Opponent Body" && crash == false) {
                            child.translateX((speed/1.5)*difficulty); } } ); }
         
            catch(e) { // We catch the exception caused by eliminating a passed car
                // We do nothing
            } }
            
            // Animates the gameplay scene
            function animateGameplay() {    
                animateGameplayPlayer();
                animateGameplayRoad();
                if (crash == false) {
                    gameplayAnimation = requestAnimationFrame(animateGameplay);
                    renderer.render(scene, camera); }
                else {
                    clearInterval(carSpawner);
                    gameOver(); } }
            
            // Animation of the player's crash. Auxiliary function of gameOver()
            function crashAnimation() {
                // Car spin animation
                if (crashType == 0 && crash == true) { // The car spins to the left
                    if (models.getObjectByName("Body").rotation.y > -0.7) { // The car spins after crashing
                        models.getObjectByName("Body").rotateY(0.12);
                        camera.translateZ(0.02); }
                    else { // The animation is over
                        gameOverScreen.style.visibility = "visible"; } }
                else if (crashType == 1 && crash == true) { // The car spins to the right
                    if (models.getObjectByName("Body").rotation.y < 0.7) { 
                        models.getObjectByName("Body").rotateY(-0.12);
                        camera.translateZ(0.02); }
                    else {
                        gameOverScreen.style.visibility = "visible"; } }
                
                // Wheel animation
                var rotazione = models.getObjectByName("Damaged Right Anterior Tyre").rotation; 
                models.getObjectByName("Damaged Right Anterior Tyre").rotation.set(rotazione.x, 0, rotazione.z);
                if (leftOrRight == 1 && models.getObjectByName("Wheel").rotation.z <= maxSteering) { // The player is still able to turn the wheel
                    models.getObjectByName("Wheel").rotateZ(steering);
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateX(-tyreTurning/2); }
                else if (leftOrRight == 2 && models.getObjectByName("Wheel").rotation.z >= -maxSteering) {
                    models.getObjectByName("Wheel").rotateZ(-steering);
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateX(tyreTurning/2); }
                else if (leftOrRight == 0 && models.getObjectByName("Wheel").rotation.z > 0.1) {
                    models.getObjectByName("Wheel").rotateZ(-steering); 
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateX(tyreTurning/2); }
                else if (leftOrRight == 0 && models.getObjectByName("Wheel").rotation.z < -0.1) {
                    models.getObjectByName("Wheel").rotateZ(steering);
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateX(-tyreTurning/2); }
                
                // Damaged tyre animation
                if (damagedTyreDirection == false && models.getObjectByName("Damaged Right Anterior Tyre").rotation.z > -0.4) { // The damaged tyre keeps switching rotation direction
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateZ(-tyreSpeed/10); }
                else {
                    damagedTyreDirection = true; }
                if (damagedTyreDirection == true && models.getObjectByName("Damaged Right Anterior Tyre").rotation.z < -0.1) {
                    models.getObjectByName("Damaged Right Anterior Tyre").rotateZ(tyreSpeed/10); }
                 else {
                    damagedTyreDirection = false; }
                
                if (crash == true) { // Continues to render the game over screen until the player returns to the main menu
                 requestAnimationFrame(crashAnimation); }
                renderer.render(scene, camera); }     
            
            // The player has hit an opponent's car
            function gameOver() {
                document.title = "Formula Driver - Game Over"
                document.body.removeChild(hud); // We remove the HUD
                gameOverScreen = document.createElement('div'); // We create the game over screen
                gameOverScreen.id = "gameover";
                gameOverScreen.innerHTML = "GAME OVER!";
                gameOverScreen.innerHTML += "<br>Passes: " + passes;
                gameOverScreen.innerHTML += "<br>Speed: " + difficulty.toFixed(1) + "<br>";
                document.body.appendChild(gameOverScreen); 
                var continueButton = document.createElement('button');
                continueButton.id = "Menu";
                continueButton.innerHTML = "Back To Menu";
                gameOverScreen.appendChild(continueButton);
                gameOverScreen.style.visibility = "hidden";
                
                models.getObjectByName("Front").visible = false; // We hide the front of the car...
                models.getObjectByName("Damaged Front").visible = true; //... to show instead its damaged version!
                
                camera = new THREE.PerspectiveCamera(30, 1, 0.1, 2000); // We update the camera
                models.getObjectByName("Front Cockipt").add(camera); // We add the camera to the cockpit so that it can rotate in synch with the car
                camera.position.set(0.0, 1.4, 2.8);
                camera.rotation.set(-0.2, 0, 0);
                // camera.scale = new THREE.Vector3(0.42, 1.0, 1.02);
                
                document.getElementById("Menu").onclick = function() { // The player returns to the menu. We reset all important values and restart the game
                    crash = false;
                    document.body.removeChild(gameOverScreen);
                    document.body.removeChild(renderer.domElement);
                    difficulty = 1.0;
                    passes = 0;
                    timer = 0;
                    damagedTyreDirection = false;
                    cockpit = true;
                    menu = true;
                    init(); };
                
                wheelScreenText();
                crashAnimation(); }
                      
            // Updates the text on the screen of the wheel. 
            function wheelScreenText() {
                var canvas = document.createElement('canvas'); // Creates a canvas where to write the text on the wheel
                var text = canvas.getContext('2d'); // It returns a CanvasRenderingContext2D: a 2D visualization of what's inside the canvas
                canvas.width = 400; // Size of the canvas
                canvas.height = 150;
                text.font = '50px Helvetica';
                text.fillStyle = 'white'; // Color of the text
                if (menu == true) { // Message to print when the player is at the menu screen
                    text.fillText('READY TO', 70, 55);
                    text.fillText('   START', 70, 120); }
                else if (crash == false) { // Message to print during regular gameplay
                    text.fillText('Passes: ' + passes, 70, 55); // Second and third parameter are x, y coordinates of text
                    text.fillText('Speed: ' + difficulty.toFixed(1), 70, 120); }
                else { // Message to print when the player has crashed
                    text.fillText('TERMINAL', 70, 55);
                    text.fillText(' DAMAGE', 70, 120); }
                var textureScreen = new THREE.Texture(canvas); // Obtains the canvas as a texture
                textureScreen.wrapS = THREE.RepeatWrapping;
                textureScreen.wrapT = THREE.RepeatWrapping;
                textureScreen.anisotropy = renderer.capabilities.getMaxAnisotropy();
                textureScreen.needsUpdate = true; // Without this, it doesn't work
                models.getObjectByName("Screen Text").material.map = textureScreen; }
            
            // Set the resolution of the renderer according to the option choosen
            function setResolutionRenderer() {
                if (lowResolution == false) { // The renderer has the same size of the browser
                    renderer.setSize(window.innerWidth, window.innerHeight); } 
                else { // The renderer has the same size of the browser but half of its internal resolution
                    renderer.setSize(window.innerWidth/2, window.innerHeight/2); // The renderer is half of its original size
                    renderer.domElement.style.width = renderer.domElement.width * 2 + 'px'; // And then we double the canvas, while the renderer keeps its size
                    renderer.domElement.style.height = renderer.domElement.height * 2 + 'px'; } }
            
            // Colors the car with according to the team choosen
            function setTeamColors() {
                if (team == 0) { // Ferrari
                    models.getObjectByName("Front").material.color = new THREE.Color(0xff0000); // We change the colors on the car
                    models.getObjectByName("Front").material.emissive = new THREE.Color(0, 0, 0); // All parts of the car share the same material, so changing the front, changes everything
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Ferrari.png"); // We load the correct logo
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam; }
                else if (team == 1) { // Mercedes   
                    models.getObjectByName("Front").material.color = new THREE.Color(0x999999); 
                    models.getObjectByName("Front").material.emissive = new THREE.Color(0, 0, 0); 
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Mercedes.png");
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam; }
                else { // RedBull
                    models.getObjectByName("Front").material.color = new THREE.Color(0x000080);
                    models.getObjectByName("Front").material.emissive = new THREE.Color(0, 0, 0); 
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Redbull.png");
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam; } }
            
            // Enable or disable shadows according to the option choosen
            function setShadows() {
                if (shadows == true) {
                    pointLight.castShadow = true; // The light can cast shadows
                    pointLight.shadow.mapSize.width = 512; // Size of the shadows: the bigger number, the higher quality, but worse performance
                    pointLight.shadow.mapSize.height = 512; 
                    models.getObjectByName("Body").traverse(function (child) { // We enable every object on the scene to receive and cast shadow
                        child.receiveShadow = true;
                        child.castShadow = true; } );
                    models.getObjectByName("Human").traverse(function (child) { 
                        child.receiveShadow = true;
                        child.castShadow = true; } );
                    models.getObjectByName("Upper Underpass").castShadow = true;
                    models.getObjectByName("Front Logo").castShadow = false; // The plane containing the logo can't cast shadow
                    models.getObjectByName("Pit Road").receiveShadow = true;
                    models.getObjectByName("Gameplay Road").receiveShadow = true;
                    models.getObjectByName("Opponent Body").castShadow = true; 
                    models.getObjectByName("Opponent Back").castShadow = true; 
                    models.getObjectByName("Opponent Front").castShadow = true; }
                else {
                    pointLight.castShadow = false;
                    models.getObjectByName("Body").traverse(function (child) { 
                        child.receiveShadow = false;
                        child.castShadow = false; } );
                    models.getObjectByName("Human").traverse(function (child) { 
                        child.receiveShadoe = false;
                        child.castShadow = false; } );
                    models.getObjectByName("Upper Underpass").castShadow = false;
                    models.getObjectByName("Pit Road").receiveShadow = false;
                    models.getObjectByName("Gameplay Road").receiveShadow = false;
                    models.getObjectByName("Opponent Body").castShadow = false; 
                    models.getObjectByName("Opponent Back").castShadow = false; 
                    models.getObjectByName("Opponent Front").castShadow = false;} }
                          
            // Creates and animates the menu
            function init() { 
                createMenu();
                animateMenu(); }
            
            // Starts the game
            init();
        </script>
    </body>
</html>